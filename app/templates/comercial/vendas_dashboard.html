<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Análise de Vendas — BI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet e Chart.js -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      background: #0b0f14;
      color: #eaf1f7;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    /* Botão voltar */
    .btn-back {
      display: inline-block;
      margin: 18px 0 0 20px;
      padding: 10px 14px;
      background: #111827;
      color: #22d3ee;
      border: 1px solid #22d3ee;
      border-radius: 10px;
      transition: .2s;
      font-weight: 700;
    }

    .btn-back:hover {
      background: #22d3ee;
      color: #0b0f14;
    }

    /* Container principal */
    #dash {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 20px 60px;
    }

    h2 {
      margin: 12px 0 16px;
      font-weight: 800;
      letter-spacing: .2px;
      color: #f7fbff;
      text-align: center;
    }

    /* Cards / layout */
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
    }

    .col-md-6 {
      flex: 1 1 48%;
      min-width: 300px;
    }

    .card {
      background: linear-gradient(180deg, #111827, #0f1621);
      border: 1px solid #1f2a37;
      border-radius: 16px;
    }

    .card-header {
      padding: 12px 16px;
      border-bottom: 1px solid #1f2a37;
      color: #dfe7ee;
      font-weight: 800;
    }

    .card-body {
      padding: 16px;
    }

    .text-muted {
      color: #c0c9d1 !important;
    }

    /* ===================== FILTROS ===================== */
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px 16px;
      align-items: end;
      margin: 8px 0 18px 0;
      background: #0f1621;
      border: 1px solid #1f2a37;
      border-radius: 14px;
      padding: 14px;
    }

    .field label {
      display: block;
      font-size: 12px;
      color: #c0c9d1;
      margin-bottom: 6px;
      font-weight: 600;
    }

    .field .form-control,
    .field .form-select {
      width: 100%;
      padding: 11px 12px;
      border-radius: 10px;
      border: 1px solid #1f2a37;
      background: #0d131b;
      color: #eef3f7;
      outline: none;
      box-shadow: 0 1px 0 #000 inset;
    }

    .field .form-control::placeholder {
      color: #9fb0bd;
    }

    /* Ícone calendário visível */
    input[type="date"] {
      color-scheme: dark;
    }

    input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1) brightness(1.6) contrast(1.2) saturate(1.2);
      opacity: .95;
    }

    /* Botão aplicar */
    .filters .actions {
      display: flex;
      justify-content: flex-end;
    }

    .btn {
      display: inline-block;
      padding: 11px 18px;
      border-radius: 10px;
      border: 1px solid #0ea5b7;
      background: #0b1f26;
      color: #aaf2ff;
      font-weight: 800;
      transition: .15s;
      white-space: nowrap;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 0 3px rgba(34, 211, 238, .15);
    }

    /* Mapa */
    #mapa {
      height: 420px;
      border-radius: 14px;
      overflow: hidden;
    }

    .leaflet-container {
      background: #0f1621;
      outline: 0;
    }

    /* Tabela */
    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table thead th {
      padding: 10px 12px;
      background: #0f1621;
      color: #c0c9d1;
      text-align: left;
      font-weight: 700;
    }

    .table tbody td {
      padding: 10px 12px;
      border-top: 1px solid #1f2a37;
    }

    .text-end {
      text-align: right;
    }

    .table-responsive {
      overflow: auto;
    }

    /* Gráficos */
    canvas {
      background: transparent;
      border-radius: 12px;
    }

    #chartRegioes,
    #chartRepresentantes,
    #chartClientes,
    #chartRefs,
    #chartLinhas,
    #chartRedesLoja {
      height: 220px !important;
    }
  </style>
</head>

<body>

  <a href="{{ url_for('routes.home') }}" class="btn-back">← Voltar para Home</a>

  <div id="dash">
    <h2>Análise de Vendas (REGIÃO)</h2>

    <!-- Última importação -->
    <div style="display:flex;justify-content:center;margin:4px 0 14px;">
      <span class="badge" style="background:rgba(34,211,238,.18);color:#8be9fd;border-radius:999px;padding:6px 12px;">
        Última importação:
        <strong style="margin-left:6px">
          {{ last_import_dt_vendas.strftime('%d/%m/%Y') if last_import_dt_vendas else '—' }}
        </strong>
      </span>
    </div>
    <a class="btn btn-outline-success" href="{{ url_for('routes.vendas_dashboard_avancado') }}">Vendas II</a>
    <hr>

    <!-- ===================== FILTROS ===================== -->
    <form id="filtros" class="filters">
      <div class="field">
        <label>De</label>
        <input type="date" class="form-control" name="data_ini" value="{{ data_ini or '' }}">
      </div>
      <div class="field">
        <label>Até</label>
        <input type="date" class="form-control" name="data_fim" value="{{ data_fim or '' }}">
      </div>
      <div class="field">
        <label>Métrica</label>
        <select class="form-select" name="metric" id="metric">
          <option value="valor" selected>Valor (R$)</option>
          <option value="quantidade">Quantidade</option>
        </select>
      </div>
      <!-- Filtro de Rede de Loja (para Top Clientes) -->
      <div class="field">
        <label>Rede de Loja (Top Clientes)</label>
        <select class="form-select" id="fRedeLoja" name="rede_loja">
          <option value="">Todas as redes</option>
        </select>
      </div>
      <div class="actions">
        <button type="button" class="btn" id="aplicar">Aplicar</button>
      </div>
    </form>

    <!-- ===================== MAPA + CHARTS ===================== -->
    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">Mapa por Estado (clique para filtrar)</div>
          <div class="card-body" style="position:relative">
            <div id="mapa"></div>
            <!-- legenda abaixo -->
            <div style="margin-top:8px;display:flex;align-items:center;gap:10px;">
              <span style="display:flex;align-items:center;gap:4px;">
                <span style="width:14px;height:14px;background:#c8d4ff;border-radius:3px;"></span> Maior
              </span>
              <span style="display:flex;align-items:center;gap:4px;">
                <span style="width:14px;height:14px;background:#1b2350;border-radius:3px;"></span> Menor
              </span>
            </div>

            <!-- UF selecionada -->
            <div style="margin-top:12px;">
              <span class="badge" style="background:rgba(34,211,238,.18);color:#8be9fd;">
                UF selecionada: <strong id="estadoSel">Brasil</strong>
              </span>
              <button type="button" id="limparUF" class="btn"
                style="margin-left:8px;padding:6px 12px;border-radius:8px;">Limpar</button>
            </div>
          </div>
        </div>
        <br>
        <div class="card mt-3">
          <div class="card-header">Vendas por Região</div>
          <div class="card-body"><canvas id="chartRegioes"></canvas></div>
        </div>
      </div>
      <br>
      <div class="col-md-6">
        <!-- Top Redes de Loja -->
        <div class="card">
          <div class="card-header">
            Top Redes de Loja <small class="text-muted" id="subUF0">(Brasil)</small>
          </div>
          <div class="card-body"><canvas id="chartRedesLoja"></canvas></div>
        </div>
        <br>
        <!-- Top Clientes por Rede -->
        <div class="card mt-3">
          <div class="card-header">
            Top Clientes por Rede
            <small class="text-muted" id="subUF2">(Brasil)</small><br>
            <small class="text-muted">Rede: <span id="lblRedeCli">Todas as redes</span></small>
          </div>
          <div class="card-body"><canvas id="chartClientes"></canvas></div>
        </div>
        <br>
        <!-- Top Representantes (comentado) -->
        <!--
        <div class="card mt-3">
          <div class="card-header">Top Representantes <small class="text-muted" id="subUF1">(Brasil)</small></div>
          <div class="card-body"><canvas id="chartRepresentantes"></canvas></div>
        </div>
        -->
      </div>
    </div>

    <br>
    <!-- Referências e Linhas (comentados a pedido, mas JS mantido) -->
    <!--
    <div class="row">
      <div class="col-md-6">
        <div class="card mt-3">
          <div class="card-header">Top Referências</div>
          <div class="card-body"><canvas id="chartRefs"></canvas></div>
        </div>
      </div>
      <br>
      <div class="col-md-6">
        <div class="card mt-3">
          <div class="card-header">Top Linhas</div>
          <div class="card-body"><canvas id="chartLinhas"></canvas></div>
        </div>
      </div>
    </div>
    <br>
    -->

    <!-- ===================== REPRESENTANTES PARADOS (comentado) ===================== -->
    <!--
    <div class="card mt-3">
      <div class="card-header">
        Representantes com última venda mais antiga <small class="text-muted" id="subUF3">(Brasil)</small>
      </div>
      <div class="card-body" style="padding:0">
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead>
              <tr>
                <th style="width:45%">Representante</th>
                <th style="width:20%">Última venda</th>
                <th style="width:20%">Dias sem vender</th>
                <th style="width:15%" class="text-end"><span id="thTotalLbl">Total</span></th>
              </tr>
            </thead>
            <tbody id="tbodyStale">
              <tr>
                <td colspan="4" class="text-center text-muted">Carregando…</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    -->

    <!-- ===================== REDES PARADAS ===================== -->
    <div class="card mt-3">
      <div class="card-header">
        Redes de loja com última venda mais antiga <small class="text-muted" id="subUF4">(Brasil)</small>
      </div>
      <div class="card-body" style="padding:0">
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead>
              <tr>
                <th style="width:30%">Rede de loja</th>
                <th style="width:30%">Cliente (última venda)</th>
                <th style="width:15%">Última venda</th>
                <th style="width:15%">Dias sem vender</th>
                <th style="width:10%" class="text-end"><span id="thTotalRede">Total</span></th>
              </tr>
            </thead>
            <tbody id="tbodyRedeStale">
              <tr>
                <td colspan="5" class="text-center text-muted">Carregando…</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <script>
    /* === Utilidades === */
    function brl(v) { return Number(v || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    function intf(v) { return Number(v || 0).toLocaleString('pt-BR'); }
    function qs(p) { const f = new URLSearchParams(p); return f.toString() ? ('?' + f.toString()) : ''; }
    function formatDateISO(iso) {
      if (!iso) return '-';
      const d = new Date(iso + 'T00:00:00');
      const dd = String(d.getDate()).padStart(2, '0'), mm = String(d.getMonth() + 1).padStart(2, '0'), yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }

    /* === Estado selecionado === */
    let UF = ""; const fForm = document.getElementById('filtros');
    document.getElementById('aplicar').onclick = () => carregarTudo();

    /* === Tema Chart.js === */
    const darkTicks = { color: '#eef3f7', font: { size: 10 } };
    const darkGrid = { color: 'rgba(148,163,184,0.28)' };
    const legendCfg = { labels: { color: '#f7fbff', boxWidth: 12 } };
    const tooltipCfg = { backgroundColor: '#0b0f14', titleColor: '#e7edf3', bodyColor: '#e7edf3', borderColor: '#1f2a37', borderWidth: 1 };
    const panelFill = {
      id: 'panelFill', beforeDraw(chart) {
        const { ctx, chartArea } = chart; ctx.save(); ctx.fillStyle = '#0f1621';
        if (chartArea) ctx.fillRect(chartArea.left, chartArea.top, chartArea.right - chartArea.left, chartArea.bottom - chartArea.top); ctx.restore();
      }
    };
    const charts = {}; // registrar instâncias para destruir

    /* === Render genérico de barras === */
    function renderBars(canvasId, labels, valores, titulo) {
      const metric = document.getElementById('metric').value;
      const ctx = document.getElementById(canvasId); if (!ctx) return;
      const short = labels.map(l => l ? (l.length > 22 ? l.substring(0, 20) + '…' : l) : '');
      const data = {
        labels: short, datasets: [{
          label: titulo, data: valores,
          backgroundColor: 'rgba(34,211,238,0.35)', borderColor: '#22d3ee'
        }]
      };
      const opt = {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: legendCfg,
          tooltip: Object.assign({}, tooltipCfg, {
            callbacks: {
              title: (items) => labels[items[0].dataIndex],
              label: (c) => (metric === 'valor' ? 'R$ ' + brl(c.parsed.y) : intf(c.parsed.y))
            }
          })
        },
        scales: {
          x: { ticks: darkTicks, grid: darkGrid },
          y: { ticks: Object.assign({}, darkTicks, { callback: (v) => metric === 'valor' ? 'R$ ' + brl(v) : intf(v) }), grid: darkGrid }
        }
      };
      if (charts[canvasId]) charts[canvasId].destroy();
      charts[canvasId] = new Chart(ctx, { type: 'bar', data, options: opt, plugins: [panelFill] });
    }

    /* Atualiza label da rede no card de Top Clientes */
    function atualizarLabelRedeClientes() {
      const selRede = document.getElementById('fRedeLoja');
      const lbl = document.getElementById('lblRedeCli');
      if (selRede && lbl) {
        lbl.textContent = selRede.value || 'Todas as redes';
      }
    }

    /* === Mapa Leaflet === */
    const map = L.map('mapa').setView([-14.2, -54.2], 4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 18 }).addTo(map);
    let geoLayer; let totalsUF = {};
    function getUF(f) { return (f?.properties?.sigla) || (f?.id) || (f?.properties?.UF) || (f?.properties?.uf) || ""; }
    function onStateClick(layer) {
      const uf = getUF(layer.feature) || "";
      UF = uf;
      const lbl = document.getElementById('estadoSel'); if (lbl) lbl.innerText = UF || 'Brasil';

      const su0 = document.getElementById('subUF0'); if (su0) su0.innerText = `(${UF || 'Brasil'})`;
      const su1 = document.getElementById('subUF1'); if (su1) su1.innerText = `(${UF || 'Brasil'})`;
      const su2 = document.getElementById('subUF2'); if (su2) su2.innerText = `(${UF || 'Brasil'})`;
      const su3 = document.getElementById('subUF3'); if (su3) su3.innerText = `(${UF || 'Brasil'})`;
      const su4 = document.getElementById('subUF4'); if (su4) su4.innerText = `(${UF || 'Brasil'})`;

      geoLayer.setStyle(() => ({ color: '#2a2a2a', weight: 1, fillOpacity: .75 }));
      layer.setStyle({ color: '#22d3ee', weight: 2, fillOpacity: .9 });
      carregarGraficos();
      carregarStale();
      carregarStaleRede(); // redes paradas
    }
    fetch("{{ url_for('static', filename='geo/br_states.json') }}")
      .then(r => r.json()).then(geo => {
        geoLayer = L.geoJSON(geo, {
          style: () => ({ color: '#2a2a2a', weight: 1, fillOpacity: .75, fillColor: '#1b2350' }),
          onEachFeature: (f, l) => l.on('click', () => onStateClick(l))
        }).addTo(map);
        carregarTudo();
      });

    /* botão Limpar UF */
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'limparUF') {
        UF = "";
        const lbl = document.getElementById('estadoSel'); if (lbl) lbl.innerText = 'Brasil';

        const su0 = document.getElementById('subUF0'); if (su0) su0.innerText = '(Brasil)';
        const su1 = document.getElementById('subUF1'); if (su1) su1.innerText = '(Brasil)';
        const su2 = document.getElementById('subUF2'); if (su2) su2.innerText = '(Brasil)';
        const su3 = document.getElementById('subUF3'); if (su3) su3.innerText = '(Brasil)';
        const su4 = document.getElementById('subUF4'); if (su4) su4.innerText = '(Brasil)';

        geoLayer.setStyle(() => ({ color: '#2a2a2a', weight: 1, fillOpacity: .75 }));
        carregarGraficos();
        carregarStale();
        carregarStaleRede();
      }
    });

    function pintarMapa() {
      if (!geoLayer) return;
      const vals = Object.values(totalsUF); const max = Math.max(1, ...vals, 1);
      function color(v) { const p = v / max; const c = Math.round(27 + p * 180); return `rgb(${c},${c + 10},255)`; }
      geoLayer.eachLayer(l => {
        const uf = getUF(l.feature); const v = totalsUF[uf] || 0;
        const metric = document.getElementById('metric').value;
        const txt = metric === 'valor' ? 'R$ ' + brl(v) : intf(v);
        l.bindTooltip(`${uf || '-'}: ${txt}`, { sticky: true, opacity: .95 });
        l.setStyle({ fillColor: color(v) });
      });
    }

    /* === Carregamento geral === */
    async function carregarTudo() {
      const p = Object.fromEntries(new FormData(fForm).entries());
      const d1 = await fetch("{{ url_for('routes.agg_estados') }}" + qs(p)).then(r => r.json());
      totalsUF = d1 || {}; pintarMapa();
      await carregarGraficos();
      await carregarTopReferencias();
      await carregarTopLinhas();
      await carregarStale();
      await carregarStaleRede();
    }

    async function carregarGraficos() {
      const pBase = Object.fromEntries(new FormData(fForm).entries());
      if (UF) pBase.estado = UF; // aplica UF nos cards que dependem do estado

      // Top Redes de Loja
      const redes = await fetch("{{ url_for('routes.agg_redes_loja') }}" + qs(pBase)).then(r => r.json());
      renderBars('chartRedesLoja', redes.map(x => x.rede_loja), redes.map(x => x.total), 'Por rede de loja');

      // Preencher select de Rede de Loja
      const selRede = document.getElementById('fRedeLoja');
      if (selRede) {
        const valorAtual = selRede.value;
        selRede.innerHTML = '<option value="">Todas as redes</option>';
        redes.forEach(r => {
          if (!r.rede_loja) return;
          const opt = document.createElement('option');
          opt.value = r.rede_loja;
          opt.textContent = r.rede_loja;
          selRede.appendChild(opt);
        });
        if (valorAtual && [...selRede.options].some(o => o.value === valorAtual)) {
          selRede.value = valorAtual;
        }
        atualizarLabelRedeClientes();
      }

      // Top Representantes
      const reps = await fetch("{{ url_for('routes.agg_representantes') }}" + qs(pBase)).then(r => r.json());
      renderBars('chartRepresentantes', reps.map(x => x.representante), reps.map(x => x.total), 'Por representante');

      // Top Clientes filtrando pela Rede de Loja selecionada (se houver)
      const pCli = { ...pBase };
      const selRede2 = document.getElementById('fRedeLoja');
      if (selRede2 && selRede2.value) {
        pCli.rede_loja = selRede2.value;
      }
      const clis = await fetch("{{ url_for('routes.agg_clientes') }}" + qs(pCli)).then(r => r.json());
      renderBars('chartClientes', clis.map(x => x.cliente), clis.map(x => x.total), 'Por cliente');

      // Regiões (sem UF, visão BR)
      const p2 = Object.fromEntries(new FormData(fForm).entries());
      const regs = await fetch("{{ url_for('routes.agg_regioes') }}" + qs(p2)).then(r => r.json());
      renderBars('chartRegioes', regs.map(x => x.regiao), regs.map(x => x.total), 'Por região');
    }

    /* Quando mudar a rede, recarregar Top Clientes */
    document.getElementById('fRedeLoja').addEventListener('change', () => {
      atualizarLabelRedeClientes();
      carregarGraficos(); // recarrega gráficos à direita com nova rede
    });

    /* === Top refs/linhas === */
    async function carregarTopReferencias() {
      const refs = await fetch("{{ url_for('routes.referencias_top') }}?limit=30").then(r => r.json());
      renderBars('chartRefs', refs.map(x => x.referencia), refs.map(x => x.total), 'Qtd vendida');
    }
    async function carregarTopLinhas() {
      const linhas = await fetch("{{ url_for('routes.referencias_linhas_top') }}?limit=30").then(r => r.json());
      renderBars('chartLinhas', linhas.map(x => x.linha), linhas.map(x => x.total), 'Qtd vendida');
    }

    /* === REPRESENTANTES PARADOS === */
    async function carregarStale() {
      const p = Object.fromEntries(new FormData(fForm).entries());
      if (UF) p.estado = UF;

      const th = document.getElementById('thTotalLbl');
      if (th) th.innerText = (p.metric === 'valor') ? 'Total (R$)' : 'Total (Qtd)';

      const su3 = document.getElementById('subUF3');
      if (su3) su3.innerText = `(${UF || 'Brasil'})`;

      const tb = document.getElementById('tbodyStale');
      if (tb) tb.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Carregando…</td></tr>`;

      const rows = await fetch("{{ url_for('routes.rep_ultimos') }}" + qs(p)).then(r => r.json());

      if (!tb) return;
      if (!rows || rows.length === 0) {
        tb.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Sem dados</td></tr>`;
        return;
      }
      tb.innerHTML = rows.map(r => `
        <tr>
          <td>${r.representante}</td>
          <td>${formatDateISO(r.ultima_data)}</td>
          <td>${(r.dias_sem_vender ?? '-')}</td>
          <td class="text-end">${(p.metric === 'valor') ? 'R$ ' + brl(r.total) : intf(r.total)}</td>
        </tr>
      `).join('');
    }

    /* === REDES PARADAS === */
    async function carregarStaleRede() {
      const p = Object.fromEntries(new FormData(fForm).entries());
      if (UF) p.estado = UF;

      const th = document.getElementById('thTotalRede');
      if (th) th.innerText = (p.metric === 'valor') ? 'Total (R$)' : 'Total (Qtd)';

      const su4 = document.getElementById('subUF4');
      if (su4) su4.innerText = `(${UF || 'Brasil'})`;

      const tb = document.getElementById('tbodyRedeStale');
      if (tb) tb.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Carregando…</td></tr>`;

      const rows = await fetch("{{ url_for('routes.rede_ultimas') }}" + qs(p)).then(r => r.json());

      if (!tb) return;
      if (!rows || rows.length === 0) {
        tb.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Sem dados</td></tr>`;
        return;
      }
      tb.innerHTML = rows.map(r => `
        <tr>
          <td>${r.rede_loja || r.rede || 'SEM REDE'}</td>
          <td>${r.cliente_ultima_venda || '-'}</td>
          <td>${formatDateISO(r.ultima_data)}</td>
          <td>${(r.dias_sem_vender ?? '-')}</td>
          <td class="text-end">${(p.metric === 'valor') ? 'R$ ' + brl(r.total) : intf(r.total)}</td>
        </tr>
      `).join('');
    }
  </script>
</body>

</html>
